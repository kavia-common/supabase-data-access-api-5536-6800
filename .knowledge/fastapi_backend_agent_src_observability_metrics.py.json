{"is_source_file": true, "format": "Python", "description": "This file implements observability metrics for a FastAPI backend, including integration with Prometheus, with fallback mechanisms. It defines functions for incrementing request and error counters, observing latency, and exposing metrics data via HTTP.", "external_files": ["../core/logging"], "external_methods": ["get_logger", "generate_latest"], "published": ["prometheus_available", "inc_requests", "inc_errors", "observe_latency", "metrics_exposition"], "classes": [], "methods": [{"name": "bool prometheus_available()", "description": "Return True if prometheus_client is installed and usable.", "scope": "", "scopeKind": ""}, {"name": "None inc_requests(route: str, method: str, status: str, value: float = 1.0)", "description": "Increment the total requests counter with specific route, method, and status labels.", "scope": "", "scopeKind": ""}, {"name": "None inc_errors(route: str, method: str, status: str, value: float = 1.0)", "description": "Increment the total errors counter with specific route, method, and status labels.", "scope": "", "scopeKind": ""}, {"name": "None observe_latency(route: str, method: str, status: str, seconds: float)", "description": "Record request latency in seconds for specific route, method, and status labels.", "scope": "", "scopeKind": ""}, {"name": "Tuple[str,bytes] metrics_exposition()", "description": "Generate and return the current metrics payload, either in Prometheus format or fallback JSON.", "scope": "", "scopeKind": ""}, {"name": "None _fallback_counter_inc(name: str, value: float = 1.0, labels: Optional[Tuple[str, ...]] = None)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "None _fallback_histogram_observe(name: str, value: float, labels: Optional[Tuple[str, ...]] = None)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "\"CollectorRegistry\" _init_prom_registry()", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "bytes generate_latest(_: Any)", "scope": "", "scopeKind": "", "description": "unavailable"}], "calls": ["get_logger(__name__)", "generate_latest(_registry)", "requests_total.labels(*labels).inc(value)", "errors_total.labels(*labels).inc(value)", "request_latency_seconds.labels(*labels).observe(seconds)", "json.dumps(data, ensure_ascii=False).encode(\"utf-8\")"], "search-terms": ["prometheus", "metrics", "observability", "prometheus metrics", "fallback metrics", "FastAPI metrics", "request latency", "error counting"], "state": 2, "file_id": 22, "knowledge_revision": 54, "git_revision": "", "ctags": [{"_type": "tag", "name": "CONTENT_TYPE_LATEST", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^    CONTENT_TYPE_LATEST = \"text\\/plain; version=0.0.4; charset=utf-8\"  # type: ignore$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "CollectorRegistry", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^    CollectorRegistry = object  # type: ignore$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "Counter", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^    Counter = object  # type: ignore$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "ERRORS_TOTAL_NAME", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^ERRORS_TOTAL_NAME = \"errors_total\"$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "Histogram", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^    Histogram = object  # type: ignore$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "REQUESTS_TOTAL_NAME", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^REQUESTS_TOTAL_NAME = \"requests_total\"$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "REQUEST_LATENCY_SECONDS_NAME", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^REQUEST_LATENCY_SECONDS_NAME = \"request_latency_seconds\"$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "_DEFAULT_LABELS", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^_DEFAULT_LABELS = (\"route\", \"method\", \"status\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "_PROM_AVAILABLE", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^    _PROM_AVAILABLE = False$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "_PROM_AVAILABLE", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^    _PROM_AVAILABLE = True$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "_fallback_counter_inc", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^def _fallback_counter_inc(name: str, value: float = 1.0, labels: Optional[Tuple[str, ...]] = Non/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(name: str, value: float = 1.0, labels: Optional[Tuple[str, ...]] = None)"}, {"_type": "tag", "name": "_fallback_counters", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^_fallback_counters: Dict[str, float] = {}$/", "language": "Python", "typeref": "typename:Dict[str, float]", "kind": "variable"}, {"_type": "tag", "name": "_fallback_histogram_observe", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^def _fallback_histogram_observe(name: str, value: float, labels: Optional[Tuple[str, ...]] = Non/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(name: str, value: float, labels: Optional[Tuple[str, ...]] = None)"}, {"_type": "tag", "name": "_fallback_histograms", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^_fallback_histograms: Dict[str, Dict[str, float]] = {}$/", "language": "Python", "typeref": "typename:Dict[str, Dict[str, float]]", "kind": "variable"}, {"_type": "tag", "name": "_fallback_lock", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^_fallback_lock = threading.RLock()$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "_init_prom_registry", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^def _init_prom_registry() -> \"CollectorRegistry\":$/", "language": "Python", "typeref": "typename:\"CollectorRegistry\"", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "_reg", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^    _reg = _init_prom_registry()$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "_registry", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^_registry: Optional[\"CollectorRegistry\"] = None$/", "language": "Python", "typeref": "typename:Optional[\"CollectorRegistry\"]", "kind": "variable"}, {"_type": "tag", "name": "errors_total", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^    errors_total = Counter($/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "errors_total", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^    errors_total = None  # type: ignore$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "generate_latest", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^    def generate_latest(_: Any) -> bytes:  # type: ignore$/", "language": "Python", "typeref": "typename:bytes", "kind": "function", "signature": "(_: Any)"}, {"_type": "tag", "name": "inc_errors", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^def inc_errors(route: str, method: str, status: str, value: float = 1.0) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(route: str, method: str, status: str, value: float = 1.0)"}, {"_type": "tag", "name": "inc_requests", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^def inc_requests(route: str, method: str, status: str, value: float = 1.0) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(route: str, method: str, status: str, value: float = 1.0)"}, {"_type": "tag", "name": "logger", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^logger = get_logger(__name__)$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "metrics_exposition", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^def metrics_exposition() -> Tuple[str, bytes]:$/", "language": "Python", "typeref": "typename:Tuple[str,bytes]", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "observe_latency", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^def observe_latency(route: str, method: str, status: str, seconds: float) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(route: str, method: str, status: str, seconds: float)"}, {"_type": "tag", "name": "prometheus_available", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^def prometheus_available() -> bool:$/", "language": "Python", "typeref": "typename:bool", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "request_latency_seconds", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^    request_latency_seconds = Histogram($/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "request_latency_seconds", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^    request_latency_seconds = None  # type: ignore$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "requests_total", "path": "/home/kavia/workspace/code-generation/supabase-data-access-api-5536-6800/fastapi_backend_agent/src/observability/metrics.py", "pattern": "/^    requests_total = Counter($/", "language": "Python", "kind": "variable"}], "hash": "3172b4d823b5ab05469a21ada0a4c329", "format-version": 4, "code-base-name": "fastapi_backend_agent", "filename": "fastapi_backend_agent/src/observability/metrics.py", "fields": [{"name": "CONTENT_TYPE_LATEST = \"text\\/plain; version=0.0.4; charset=utf-8\"  # type: ignore", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "CollectorRegistry = object  # type: ignore", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "Counter = object  # type: ignore", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "ERRORS_TOTAL_NAME = \"errors_total\"", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "Histogram = object  # type: ignore", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "REQUESTS_TOTAL_NAME = \"requests_total\"", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "REQUEST_LATENCY_SECONDS_NAME = \"request_latency_seconds\"", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "_DEFAULT_LABELS = (\"route\", \"method\", \"status\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "_PROM_AVAILABLE = False", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "_PROM_AVAILABLE = True", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "Dict[str, float] _fallback_counters", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "Dict[str, Dict[str, float]] _fallback_histograms", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "_fallback_lock = threading.RLock()", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "_reg = _init_prom_registry()", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "Optional[\"CollectorRegistry\"] _registry", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "errors_total = Counter(", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "errors_total = None  # type: ignore", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "logger = get_logger(__name__)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "request_latency_seconds = Histogram(", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "request_latency_seconds = None  # type: ignore", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "requests_total = Counter(", "scope": "", "scopeKind": "", "description": "unavailable"}], "revision_history": [{"54": ""}]}